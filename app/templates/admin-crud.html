<!DOCTYPE html>
    <html lang="esp">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Plantilla de prueba</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/crud.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">
    </head>

    <body>
        <div class="principal-content">
            
            {% include 'nav-bar-pri.html' %}

            <header class="header-crud">
                Lista de usarios
            </header>

            {% include 'aside.html' %}
    

            <main class="crud-content">
                <div class="content-search-bar">
                    <div class="search-bar">
                        <input id="input-search" class="input-search" type="text" placeholder="Buscar">
                        <button class="button-search">
                            <img class="svg-search" src="{{ url_for('static', filename='img/search.svg') }}" alt="search">
                        </button>
                    </div>
    
                    <div class="content-order-filter">
                        <button class="button-search">
                            <img class="svg-search" src="{{ url_for('static', filename='img/order.svg') }}">
                        </button>
                        <button class="button-search">
                            <img class="svg-search" src="{{ url_for('static', filename='img/filter.SVG') }}">
                        </button>
                    </div>

                    <div class="results-content" id="results">

                        <!-- Template oculto que se clona para cada resultado -->
                        <button class="result-row-template" hidden onclick="modal_search()">
                            <ul>
                                <li class="id_search"></li>
                                <li class="firstname_search"></li>
                                <li class="lastname_search"></li>
                                <li class="email_search"></li>
                            </ul>
                        </button>

                    </div>
                </div>

                <form class="users-content">
                    
                {%for users in users%}
                    <div class="div-user">
                        <ul>
                            <li>
                                {# Emitir el objeto/tupla `users` como JSON en el value para parsearlo en JS #}
                                <input type="radio" name="user" value='{{ users | tojson | safe }}'>
                            </li>
                            <li>
                                {{users[0]}}
                            </li>
                            <li>
                                {{users[1]}}
                            </li>
                            <li>
                                {{users[2]}}
                            </li>
                            <li>
                                {{users[4]}}
                            </li>
                            <li>
                                {{users[5]}}
                            </li>
                            <li>
                                {{users[10]}}
                            </li>


                            <li class="more-button-content">
                                <button class="more-button" name="more">
                                    <img class="svg-search" src="{{ url_for('static', filename='img/more.SVG') }}" alt="...">
                                </button>
                            </li>
                        </ul>
                    </div>
                {%endfor%}

                </form>

                <div class="crud-buttons-content">
                    <button class="crud-button" id="add-user-btn">Agregar usuario</button>
                    <!-- quitar onclick para evitar llamadas duplicadas -->
                    <button class="crud-button" id="del-btn">Eliminar usuario</button>
                    <button class="crud-button" id="act-btn">Actualizar usuario</button>
                </div>
            </main>
            
        </div>
        

        <div class="modal-add-user">
            <div class="add-user">
                <span class="close_btn" id="close-modal-btn">&times;</span>
                <h2>Agregar usuario</h2>
                <form class="add-user-form" method="post" action="{{ url_for('add_user') }}">

                    <div class="div-campo">
                        <label for="firstname">Nombre:</label>
                        <input class="campo" type="text" name="firstname" required>
                    </div>
                    <div class="div-campo">
                        <label for="lastname">Apellido:</label>
                        <input class="campo" type="text" name="lastname" required>
                    </div>

                    <div class="div-campo">
                        <label for="email">Email:</label>
                        <input class="campo" type="email" name="email" required>
                    </div>

                    <div class="div-campo">
                        <label for="telefono">Teléfono:</label>
                        <input class="campo" type="tel" name="telefono" required>
                    </div>

                    <div class="div-campo">
                        <label for="password">Contraseña:</label>
                        <input class="campo" type="password" name="password" required>
                    </div>

                    <div class="div-campo">
                        <label for="nacimiento">Fecha de nacimiento:</label>
                        <input class="campo" type="date" name="nacimiento" required>
                    </div>

                    <div class="div-campo">
                        <label for="tipo_usuario">Tipo de usuario:</label>
                        <select class="campo" name="tipo_usuario" required>
                            <option value=0>Admin</option>
                            <option value=1>User</option>

                        </select>
                    </div>

                    <button class="form_button"  type="submit">Agregar</button>

                </form>

            </div>
        </div>
        
        <div class="del-confirm">
            <div class="window-del">
                <span class="close_btn" id="close-modal-btn">&times;</span>
                <h3 class="del-title">¿Está seguro de borrar al usuario <span id="name"></span> </h3>
                <div class="del-actions">
                     <form id="form-del" method="post">
                        <button class="confirm-btn" id="confirm-delete-btn">Aceptar</button>
                     </form>
                    <button class="cancel_btn cancel">Cancelar</button>
                </div>
            </div>
        </div>

        <div class="modal-act-user">
            <div class="add-user">
                <span class="close_btn" id="close-modal-btn">&times;</span>
                <h2>Actualizar usuario</h2>
                <form  class="add-user-form" method="post" id="form-act">

                    <div class="div-campo">
                        <label for="firstname">Nombre:</label>
                        <input class="campo" type="text" id="firstname" name="firstname" required>
                    </div>
                    <div class="div-campo">
                        <label for="lastname">Apellido:</label>
                        <input class="campo" type="text" id="lastname" name="lastname" required>
                    </div>

                    <div class="div-campo">
                        <label for="email">Email:</label>
                        <input class="campo" type="email" id="email" name="email" required>
                    </div>

                    <div class="div-campo">
                        <label for="telefono">Teléfono:</label>
                        <input class="campo" type="tel" id="telefono" name="telefono" required>
                    </div>

                    <div class="div-campo">
                        <label for="tipo_usuario">Tipo de usuario:</label>
                        <select class="campo" name="tipo_usuario" required>
                            <option value=0>Admin</option>
                            <option value=1>User</option>

                        </select>
                    </div>

                    <div class="del-actions">
                        <button class="form_button"  type="submit">Actualizar</button>
                        <button class="form_button cancel"  type="button">Cancelar</button>
                    </div>
                </form>

            </div>
        </div>


    </body>

    <script>
        let run = true

        const delform = document.getElementById("form-del");
        const actform = document.getElementById("form-act");

        function modal_search() {
            console.log("click search")
        }

        const searchInput = document.getElementById('input-search');

        searchInput.addEventListener('focus', function() {
            document.getElementById('results').classList.add('active');
            
        });
        searchInput.addEventListener('input', function() {
            let results = search(searchInput.value);
        });

        searchInput.addEventListener('blur', function() {
            // ocultar resultados después de un breve retraso para permitir clics
            setTimeout(() => {
                document.getElementById('results').classList.remove('active');
            }, 200);
        });




        async function search(str) {
            const respuesta = await fetch('/admin/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_str: str })
            });
            data = await respuesta.json();

            // seleccionar template y contenedor
            const template = document.querySelector(".result-row-template");
            const container = document.getElementById("results");

            // eliminar filas anteriores (solo aquellas generadas), mantener el encabezado
            container.querySelectorAll(".result-row").forEach(n => n.remove());

            // si no hay template o no hay resultados, salir
            if (!template) {
                console.warn("No se encontró el template .result-row-template");
                return;
            }
            if (!data || !Array.isArray(data.results)) return;

            data.results.forEach(res => {
                // clonar template y activar
                const clone = template.cloneNode(true);
                clone.classList.remove("result-row-template");
                clone.classList.add("result-row");
                clone.classList.add("result-div")
                clone.hidden = false;

                // rellenar solo el interior (ajusta índices según tu respuesta)
                // ejemplo: res[0]=id, res[1]=firstname, res[2]=lastname, res[4]=email
                const idEl = clone.querySelector(".id_search");
                const fnEl = clone.querySelector(".firstname_search");
                const lnEl = clone.querySelector(".lastname_search");
                const emailEl = clone.querySelector(".email_search");

                if (idEl) idEl.textContent = res[0] ?? "";
                if (fnEl) fnEl.textContent = res[1] ?? "";
                if (lnEl) lnEl.textContent = res[2] ?? "";
                if (emailEl) emailEl.textContent = res[5] ?? "";

                // insertar en el contenedor
                container.appendChild(clone);
            });
        }

        /*const search_but = document.querySelectorAll(".result-div");
        search_but.forEach(but => {
            but.addEventListener("click", () => {
                console.log("btn _ bus");
                    });
                });*/

        async function obt_sel() {
            // Selecciona el radio checked
            const form = {
                first_name : document.getElementById('firstname'),
                last_name : document.getElementById('lastname'),
                email : document.getElementById('email'),
                telefono : document.getElementById('telefono'),
                tipo_usuario : document.getElementById('tipo_usuario')    
            };
            const checked = document.querySelector('input[name="user"]:checked');
            if (!checked) {

                alert("Por favor, seleccione un usuario antes de continuar.");

                run = false
                return false
            }
            const raw = checked.value;
            let parsed = null;
            try {
                parsed = JSON.parse(raw);
            } catch (err) {
                console.error('Error parseando el value JSON del radio:', err, 'raw:', raw);
                // Intentar evaluar como fallback (no recomendado en producción)
                try { parsed = eval(raw); } catch (err2) { parsed = raw; }
            }

            // Asegurar que parsed sea una lista/array antes de usar índices
            const spanName = document.getElementById('name');
            if (Array.isArray(parsed) || (typeof parsed === 'object' && parsed !== null)) {
                // Si es objeto, intentar extraer propiedades comunes (nombre, id)
                if (Array.isArray(parsed)) {
                    delform.action = `/admin/crud/delete/${parsed[0]}`;
                    actform.action = `/admin/crud/act/${parsed[0]}`;

                    spanName.textContent = parsed[1] !== undefined ? parsed[1] : JSON.stringify(parsed);
                    form.first_name.value = parsed[1];
                    form.last_name.value = parsed[2];
                    form.email.value = parsed[5];
                    form.telefono.value = parsed[4];
                 
                    
                    run = true
                    return true;
                } else {
                    // objeto: buscar keys comunes
                    spanName.textContent = parsed.name || parsed.first_name || parsed[1] || JSON.stringify(parsed);
                }
                console.log('Usuario seleccionado (parsed):', parsed);
                return true;
            } else {
                // No es array u object; mostrar raw
                spanName.textContent = String(parsed);
                console.log('Usuario seleccionado (raw):', parsed);
                return true;
            }


        }

         class modal {
            constructor(modal, btn) {
                this.modal = document.querySelector(modal);
                this.btn = document.getElementById(btn);
                // seleccionar los botones de cierre dentro del modal
                this.btn_close = this.modal.querySelectorAll(".close_btn");
                this.cancel_btn = this.modal.querySelectorAll(".cancel");

                // esperar la respuesta de obt_sel antes de abrir el modal
                this.btn.addEventListener("click", async (e) => {
                    // prevenir comportamiento por defecto si es un <button> en un form

                    const selected = await obt_sel();
                    // si obt_sel devuelve null o false, no abrir el modal
                    if (selected && modal !== ".modal-add-user") {
                         e.preventDefault();
                        this.modal.classList.toggle("active");
                        console.log(modal, "toggle click");
                    }
                    else if (modal === ".modal-add-user") {
                        e.preventDefault();
                        this.modal.classList.toggle("active");
                        console.log(modal, "toggle click");
                    }
                    else {
                        console.log(modal, "no se abrió el modal - no hay selección");
                    }
                });
        

                this.btn_close.forEach(close => {
                    close.addEventListener("click", () => {
                        this.modal.classList.remove("active");
                        console.log(modal, "close click");
                    });
                });
                this.cancel_btn.forEach(close => {
                    close.addEventListener("click", () => {
                        this.modal.classList.remove("active");
                    });
                });

                }

            }

        const add_user = new modal(".modal-add-user", "add-user-btn");
        const del_user = new modal(".del-confirm", "del-btn");
        const act_user = new modal(".modal-act-user", "act-btn");
    </script>

</html>
